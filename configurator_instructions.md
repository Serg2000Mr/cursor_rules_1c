# Инструкция по внедрению изменений в Конфигуратор

> **ТЗ 67470:** в именах новых объектов/форм/команд не использовать префиксы "акс"/"уас". Для новых объектов и модулей использовать префикс `гк_` (стандарт проекта).

## 1. Регистр сведений `гк_ЦеныПоставщиков` (Задача 67472)

> Создать в **Основной конфигурации**.

### 1.1 Общие свойства

- **Имя**: `гк_ЦеныПоставщиков`
- **Синоним**: Цены поставщиков для Протокола согласования цен
- **Периодичность**: По позиции регистратора
- **Режим записи**: Подчинение регистратору
- **Регистраторы** (5 документов):
  - `ВводОстатков`
  - `ОприходованиеИзлишковТоваров`
  - `ПриобретениеТоваровУслуг`
  - `ПередачаТоваровМеждуОрганизациями`
  - `КорректировкаПриобретения`

### 1.2 Измерения

| Имя | Тип | Подсказка |
|-----|-----|-----------|
| `Организация` | СправочникСсылка.Организации | Организация предприятия, от имени которой оформляется документ |
| `Номенклатура` | СправочникСсылка.Номенклатура | Номенклатурная позиция для передачи или услуга |
| `Характеристика` | СправочникСсылка.ХарактеристикиНоменклатуры | Если у выбранной номенклатуры используются характеристики, то необходимо выбрать характеристику номенклатуры |
| `Серия` | СправочникСсылка.СерииНоменклатуры | Серия товара |
| `ДанныеПроизводителя` | Булево | Признак закупки у производителя |

### 1.3 Ресурсы

| Имя | Тип | Синоним | Подсказка |
|-----|-----|---------|-----------|
| `Упаковка` | СправочникСсылка.УпаковкиЕдиницыИзмерения | — | Упаковка номенклатуры, если есть |
| `ЦенаБезНДС` | Число(15,2), неотрицательное | Цена без НДС в рублях | Цена поставщика без НДС (руб) |
| `ЦенаСНДС` | Число(15,2), неотрицательное | Цена с НДС в рублях | Цена поставщика с НДС (руб) |
| `УСН_ЕНВД` | Булево | УСН ЕНВД | — |
| `ЦенаЗарегистрированнаяПроизводителем` | Число(15,2), неотрицательное | Зарегистрированная цена | Зарегистрированная предельная цена |
| `ДатаРеализацииПроизводителем` | Дата (состав: Дата) | Дата реализации производителем | Дата реализации товара производителем |

### 1.4 Существующие регистры для расчёта ПДЦ (справочно)

- `гк_ЦеныГРПОЦЖНВЛП` — использовать с отбором `ТипЦены = "ГРЛС"` для получения зарегистрированной цены
- `НаценкиНаЖНВЛП` — использовать с отбором `ВидПрепарата = "ЖНВЛП"` для получения предельных наценок

## 2. Документ ПриобретениеТоваровУслуг (Основная конфигурация)

### 2.1 Новые реквизиты Шапки

| Имя | Тип | Синоним | Подсказка |
|-----|-----|---------|-----------|
| `гк_МаксимальнаяДлинаЦепочкиПоставки` | Число(2,0), неотрицательное | Длина цепочки поставки | Максимальное количество посредников (оптовых звеньев) в цепочке |
| `гк_ЦПСогласована` | Булево | ЦП согласована | Цепочка поставки согласована |

> **ТЗ 67470:** при копировании документа реквизиты `гк_МаксимальнаяДлинаЦепочкиПоставки` и `гк_ЦПСогласована` должны очищаться.

### 2.2 Новая Табличная Часть `гк_ЦеныПоставщиков`

> **ОБЯЗАТЕЛЬНО.** ТЧ нужна для хранения данных, введённых в форме «Данные протокола согласования цен». Данные сохраняются в документе и при проведении формируют движения по РС `гк_ЦеныПоставщиков`.

| Имя | Тип | Назначение |
|-----|-----|------------|
| `ИдентификаторСтроки` | Строка(36) | UUID для связи со строкой ТЧ Товары |
| `НомерПоставщика` | Число(2,0) | Номер звена цепочки (1 = производитель, 2 = первый посредник, ...) |
| `ДанныеПроизводителя` | Булево | Признак закупки у производителя |
| `Упаковка` | СправочникСсылка.УпаковкиЕдиницыИзмерения | Упаковка номенклатуры |
| `ЦенаБезНДС` | Число(15,2) | Цена поставщика без НДС |
| `ЦенаСНДС` | Число(15,2) | Цена поставщика с НДС |
| `УСН_ЕНВД` | Булево | Признак УСН/ЕНВД |
| `ЦенаЗарегистрированнаяПроизводителем` | Число(15,2) | Зарегистрированная цена |
| `ДатаРеализацииПроизводителем` | Дата | Дата реализации производителем |

### 2.3 Реквизиты ТЧ `Товары`

Для связи строки товаров с данными цепочки нужен реквизит:

| Имя | Тип | Назначение |
|-----|-----|------------|
| `гк_ИдентификаторСтроки` | Строка(36) | UUID для связи с ТЧ `гк_ЦеныПоставщиков` |

> Остальные данные цепочки хранятся в ТЧ `гк_ЦеныПоставщиков`, а не в ТЧ Товары.

## 3. Общие модули и Формы (Расширение ГК_Основное)

### 3.1 Общая форма `гк_ДанныеПротоколаСогласованияЦен`

- Перенести форму из УАС (аналог `УАС_ДанныеПротоколаСогласованияЦен`) для ввода/корректировки данных протокола по строке товаров.
- **ТЗ 67470:** убрать/закомментировать код, который устанавливает доступность элементов в зависимости от роли `аксДоступКПротоколуРазногласийПолный`.

### 3.2 Форма документа `ПриобретениеТоваровУслуг`

> **ВАЖНО:** Все изменения на формах типовых документов делаются **программно** в модуле формы расширения ГК_Основное через общий модуль `РаботаСФормами`. Непосредственные изменения XML формы в конфигураторе не производятся.

#### 3.2.1 Закладка "Цепочка поставки"

**Реализация в модуле формы (процедура `гк_ПриСозданииНаСервереПеред` или `гк_ПриЧтенииСозданииНаСервере`):**

Программно создаются следующие элементы:
- **Страница** `гк_СтраницаЦепочкаПоставки` в группе `ГруппаСтраницы`
- **Группа** `гк_ГруппаШапкаЦП` — для горизонтального размещения полей
- **Поле "Статус"** (`гк_ПолеЦПСогласована`) → `Объект.гк_ЦПСогласована`
- **Поле "Длина цепочки поставки"** (`гк_ПолеДлинаЦепочки`) → `Объект.гк_МаксимальнаяДлинаЦепочкиПоставки`
- **Таблица** (`гк_ТаблицаЦеныПоставщиков`) → `Объект.гк_ЦеныПоставщиков`

Используемые функции: `РаботаСФормами.НовоеПолеФормы()`.

> **ТЗ 67470 п.5.4:** в рамках проверки достаточно отображения данных на закладке (редактирование не требуется).

#### 3.2.2 Командная панель ТЧ Товары

**Программно добавляется:**
- **Команда** `гк_ОтобразитьДанныеПротокола` с действием `гк_Подключаемый_ОтобразитьДанныеПротокола`
- **Кнопка** `гк_КнопкаОтобразитьПротокол` в `ТоварыКоманднаяПанель`

Логика: переключает видимость группы колонок «Протокол согласования цен».

#### 3.2.3 Колонки в таблице Товары (при нажатой кнопке)

**Программно добавляются:**

| Элемент | Назначение |
|---------|------------|
| **Группа** `гк_ГруппаПротоколЦен` (ВидГруппыФормы.ГруппаКолонок) | Группирует колонки протокола |
| **Кнопка** `гк_КолонкаДанныеПротокола` | Открывает форму `гк_ДанныеПротоколаСогласованияЦен` |
| **Поле** `гк_ТоварыПризнакЦП` | Признак проверки цепочки поставки (Пр.ЦП) |

Группа изначально скрыта (`Видимость = Ложь`).

#### 3.2.4 Логика сохранения данных

1. Пользователь нажимает кнопку в колонке «Данные протокола»
2. Открывается форма `гк_ДанныеПротоколаСогласованияЦен`
3. Пользователь вводит данные цепочки
4. По кнопке «Завершить редактирование»:
   - Данные сохраняются в ТЧ `гк_ЦеныПоставщиков` документа
   - Устанавливается `гк_ИдентификаторСтроки` в строке Товары
5. При повторном открытии данные отображаются из ТЧ

## 4. Роли (Права доступа)

> Создать в **Основной конфигурации**.

| Роль | Права | Описание |
|------|-------|----------|
| `гк_ЧтениеЦеныПоставщиковДляПротоколаСогласованияЦен` | Чтение | Просмотр данных регистра `гк_ЦеныПоставщиков` |
| `гк_ИзменениеЦеныПоставщиковДляПротоколаСогласованияЦен` | Изменение | Редактирование данных регистра |

> **ТЗ 67470:** отдельные роли для доступа к реквизитам `гк_ДлинаЦепочкиПоставки` и `гк_ЦПСогласована` НЕ требуются — доступ определяется правами на документ.

## 5. Чек-лист проверки (по ТЗ 67470 п.5)

### 5.1 Метаданные
- [ ] Регистр `гк_ЦеныПоставщиков` создан с правильными измерениями, ресурсами, синонимами и подсказками
- [ ] Регистр имеет периодичность "По позиции регистратора"
- [ ] Регистр имеет 5 регистраторов
- [ ] ТЧ `гк_ЦеныПоставщиков` создана в документе ПТУ
- [ ] Реквизиты шапки `гк_МаксимальнаяДлинаЦепочкиПоставки`, `гк_ЦПСогласована` добавлены
- [ ] Реквизит `гк_ИдентификаторСтроки` добавлен в ТЧ Товары
- [ ] При копировании документа реквизиты шапки очищаются
- [ ] Роли созданы

### 5.2 Интерфейс формы ПТУ
- [ ] На командной панели ТЧ Товары есть кнопка «Отобразить данные протокола согласования цен»
- [ ] При нажатии кнопки появляется группа колонок «Протокол согласования цен» и колонка «Пр.ЦП»
- [ ] В колонке «Данные протокола» работает кнопка выбора
- [ ] Открывается форма `гк_ДанныеПротоколаСогласованияЦен`
- [ ] Введённые данные сохраняются и отображаются при повторном открытии

### 5.3 Закладка "Цепочка поставки"
- [ ] Закладка добавлена на форму
- [ ] Поле "Статус" связано с `гк_ЦПСогласована`
- [ ] Поле "Длина цепочки поставки" связано с `гк_МаксимальнаяДлинаЦепочкиПоставки`
- [ ] Данные цепочки отображаются в таблице

### 5.4 Проведение документа
- [ ] При проведении формируются движения по РС `гк_ЦеныПоставщиков`
- [ ] Записи регистра видны в типовом отчёте по движениям
